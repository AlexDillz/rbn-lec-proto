<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–¢–µ—Å—Ç –ø–æ –ª–µ–∫—Ü–∏–∏ ‚Äî –õ–æ–≥–∏–∫–∞ —Å–º–µ–Ω—ã</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../theme.js" defer></script>
  <style>
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal .card{max-width:460px;width:92%}
    .hidden{display:none}

    /* —É–Ω–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –≤–∏–¥ –∫–Ω–æ–ø–æ–∫ –∏ –∏—Ö disabled */
    .btn{
      background: transparent;
      color: inherit;
      cursor: pointer;
      user-select: none;
      display:inline-flex;align-items:center;gap:6px;
      padding:8px 12px;border:1px solid var(--border);border-radius:10px;text-decoration:none;
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .q{margin:14px 0}
    .q h3{margin:0 0 8px;font-size:16px}
    .ok{
      padding:16px;border:1px solid var(--border);border-radius:12px;
      background:#eaffea;margin-top:12px;color:#064e3b;font-weight:600
    }
  </style>
</head>
<body>
  <button id="theme-toggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô Dark mode</button>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
  <div id="regModal" class="modal">
    <article class="card">
      <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ e-mail, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ç–µ—Å—Ç.</p>
      <form id="regForm" action="javascript:void(0)">
        <p><input required name="name" placeholder="–ò–º—è" style="width:100%;padding:8px"></p>
        <p><input required type="email" name="email" placeholder="E-mail" style="width:100%;padding:8px"></p>
        <button class="btn" type="submit">–ù–∞—á–∞—Ç—å</button>
      </form>
    </article>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ "—Å–ø–∞—Å–∏–±–æ" -->
  <div id="doneModal" class="modal hidden">
    <article class="card">
      <h2>–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ!</h2>
      <p id="scoreLine" style="margin-top:8px">–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –∑–∞–ø–∏—Å–∞–Ω—ã.</p>
      <p style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
        <a class="btn" href="../index.html">‚Ü© –ù–∞ –Ω–∞—á–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É</a>
        <button id="retake" class="btn" type="button">–ü—Ä–æ–π—Ç–∏ –µ—â—ë —Ä–∞–∑</button>
      </p>
    </article>
  </div>

  <main class="card" style="margin-top:52px">
    <h1>–¢–µ—Å—Ç –ø–æ –ª–µ–∫—Ü–∏–∏</h1>
    <div id="quiz">
      <div class="q">
        <h3>1) –ö –∫–∞–∫–æ–º—É –ø–µ—Ä–∏–æ–¥—É –æ—Ç–Ω–æ—Å—è—Ç—Å—è –ø–µ—Ä–≤—ã–µ 1‚Äì3 –¥–Ω—è?</h3>
        <label><input type="radio" name="q1" value="a"> –û—Å–Ω–æ–≤–Ω–æ–π</label><br>
        <label><input type="radio" name="q1" value="b"> –ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–π</label><br>
        <label><input type="radio" name="q1" value="c"> –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π</label>
      </div>
      <div class="q">
        <h3>2) –ö—Ä–∞—Ç–∫–∏–π –¥–µ–≤–∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞:</h3>
        <label><input type="radio" name="q2" value="a"> –¢–µ–ø–ª–æ—Ç–∞! –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å!</label><br>
        <label><input type="radio" name="q2" value="b"> –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ! –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å! –ú–∞–∂–æ—Ä! –î—Ä—É–∂–±–∞!</label><br>
        <label><input type="radio" name="q2" value="c"> –£–¥–∏–≤–ª–µ–Ω–∏–µ! –¢–µ–º–ø! –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ!</label>
      </div>
      <div class="q">
        <h3>3) –ß—Ç–æ –¥–µ–ª–∞—Ç—å –∑–∞ 2‚Äì3 –¥–Ω—è –¥–æ –∫–æ–Ω—Ü–∞?</h3>
        <label><input type="radio" name="q3" value="a"> –ü–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—é—Ä–ø—Ä–∏–∑—ã, –≥–æ—Ç–æ–≤–∏—Ç—å —Ç—ë–ø–ª–æ–µ —Ä–∞—Å—Å—Ç–∞–≤–∞–Ω–∏–µ</label><br>
        <label><input type="radio" name="q3" value="b"> –ù–∞–∑–Ω–∞—á–∞—Ç—å –æ—Ä–≥–∞–Ω–æ–≤ —Å–∞–º–æ—É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</label><br>
        <label><input type="radio" name="q3" value="c"> –ü—Ä–æ–≤–æ–¥–∏—Ç—å —Ä–∞–∑–≤–µ–¥–∫—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –¥–µ–ª</label>
      </div>

      <button id="submitBtn" class="btn" type="button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <div id="done" class="ok hidden">–û—Ç–≤–µ—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã.</div>
    </div>

    <p style="margin-top:12px"><a class="btn" href="../index.html">‚Üê –ù–∞–∑–∞–¥</a></p>
  </main>

  <script>
    // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
    const SCRIPT_ENDPOINT = 'https://script.google.com/macros/s/AKfycbz5fUH5QPufzNv6fH3lBQGe_4lZ0SQckSEyKAV8nSDMFP8G35xmaEx9cyq9SR_ZXN9c/exec';
    const TEST_ID = 'logic-shift-dev';

    // –ö–ª—é—á–∏ localStorage
    const LS_USER      = `test:${TEST_ID}:user`;
    const LS_CLIENT_ID = `test:${TEST_ID}:clientId`;
    const LS_ANSWERS   = `test:${TEST_ID}:answers`;
    const LS_ATTEMPT   = `test:${TEST_ID}:attempt`;
    const LS_SCORE     = `test:${TEST_ID}:clientScore`;

    // clientId
    let clientId = localStorage.getItem(LS_CLIENT_ID);
    if (!clientId) {
      clientId = Date.now() + Math.random().toString(36).slice(2);
      localStorage.setItem(LS_CLIENT_ID, clientId);
    }

    // –ø–æ–ø—ã—Ç–∫–∏
    let attempt = parseInt(localStorage.getItem(LS_ATTEMPT) || '0', 10);

    // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –æ—Ç–≤–µ—Ç—ã
    let user = null;
    try { user = JSON.parse(localStorage.getItem(LS_USER) || 'null'); } catch(_) {}
    let savedAnswers = {};
    try { savedAnswers = JSON.parse(localStorage.getItem(LS_ANSWERS) || '{}'); } catch(_) {}

    // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –æ—Ç–≤–µ—Ç—ã –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    window.addEventListener('DOMContentLoaded', ()=>{
      for (const [name,val] of Object.entries(savedAnswers)) {
        const el = document.querySelector(`input[name="${name}"][value="${val}"]`);
        if (el) el.checked = true;
      }
      if (user) document.getElementById('regModal').classList.add('hidden');
    });

    // —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤—ã–±–æ—Ä –Ω–∞ –ª–µ—Ç—É
    document.querySelectorAll('input[type="radio"]').forEach(inp=>{
      inp.addEventListener('change', ()=>{
        localStorage.setItem(LS_ANSWERS, JSON.stringify(collectAnswers()));
      });
    });

    // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    document.getElementById('regForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      user = { name: fd.get('name'), email: fd.get('email') };
      localStorage.setItem(LS_USER, JSON.stringify(user));
      document.getElementById('regModal').classList.add('hidden');
    });

    // –æ—Ç–ø—Ä–∞–≤–∫–∞
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.addEventListener('click', async ()=>{
      if (!user) { alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.'); return; }

      const answers = collectAnswers();
      const correct = { q1:'c', q2:'b', q3:'a' }; // —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–∫–∞–∑–∞ x/y
      const total = Object.keys(answers).length;
      const clientScore = Object.keys(correct).reduce((s,k)=> s + (answers[k]===correct[k] ? 1 : 0), 0);

      submitBtn.disabled = true;
      submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶';

      try {
        const payload = {
          ...user, clientId, testId: TEST_ID,
          attempt: attempt + 1,              // –Ω–æ–º–µ—Ä —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–∏
          score: clientScore,
          answers
        };
        await fetch(SCRIPT_ENDPOINT, {
          method: 'POST',
          mode:   'no-cors',
          headers:{ 'Content-Type':'text/plain;charset=utf-8' },
          body:   JSON.stringify(payload)
        });

        // —Å–æ—Ö—Ä–∞–Ω–∏–º –ø–æ–ø—ã—Ç–∫—É –∏ —Å—á—ë—Ç
        attempt += 1;
        localStorage.setItem(LS_ATTEMPT, String(attempt));
        localStorage.setItem(LS_SCORE, `${clientScore}/${total}`);

        // –ø–æ–∫–∞–∂–µ–º –º–æ–¥–∞–ª–∫—É —Å–æ —Å—á—ë—Ç–æ–º
        showThanks(`${clientScore}/${total}`);

        // –Ω–µ —Å—Ç–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç—ã ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç —Å–≤–æ–∏ –≤—ã–±–æ—Ä—ã
        document.getElementById('done').classList.remove('hidden');
      } catch (err) {
        console.error(err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
      }
    });

    // –ö–Ω–æ–ø–∫–∞ ¬´–ü—Ä–æ–π—Ç–∏ –µ—â—ë —Ä–∞–∑¬ª
    document.getElementById('retake').addEventListener('click', ()=>{
      // –æ—á–∏—Å—Ç–∏–º –≤—ã–±–æ—Ä –∏ —Ñ–æ—Ä–º—É, –æ—Å—Ç–∞–≤–∏–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
      localStorage.removeItem(LS_ANSWERS);
      document.querySelectorAll('input[type="radio"]:checked').forEach(inp=> inp.checked = false);
      document.getElementById('doneModal').classList.add('hidden');
      // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ç–º–µ—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å ‚Äî —ç—Ç–æ –±—É–¥–µ—Ç –ø–æ–ø—ã—Ç–∫–∞ ‚Ññ attempt+1
    });

    // helpers
    function collectAnswers(){
      const obj = {};
      document.querySelectorAll('input[type="radio"]:checked').forEach(inp=>{
        obj[inp.name] = inp.value;
      });
      return obj;
    }

    function showThanks(scoreStr){
      const line = document.getElementById('scoreLine');
      line.textContent = scoreStr ? `–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –∑–∞–ø–∏—Å–∞–Ω—ã. –†–µ–∑—É–ª—å—Ç–∞—Ç: ${scoreStr}.` : '–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –∑–∞–ø–∏—Å–∞–Ω—ã.';
      document.getElementById('doneModal').classList.remove('hidden');
    }
  </script>
</body>
</html>
