<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–¢–µ—Å—Ç—ã</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../theme.js" defer></script>
  <style>
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center}
    .modal .card{max-width:420px;width:92%}
    .hidden{display:none}
    .q{margin:12px 0}
    .q h3{margin:0 0 8px;font-size:16px}
    .ok{padding:16px;border:1px solid var(--border);border-radius:12px;background:#eaffea;margin-top:12px}
    .ok{
    padding:16px;border:1px solid var(--border);border-radius:12px;
    background:#eaffea;margin-top:12px;
    color:#064e3b;                /* —Ç—ë–º–Ω–æ-–∑–µ–ª—ë–Ω—ã–π —Ç–µ–∫—Å—Ç, –≤–∏–¥–Ω–æ –≤ dark */
    font-weight:600;
    }
  </style>
</head>
<body>
  <button id="theme-toggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô Dark mode</button>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
  <div id="regModal" class="modal">
    <article class="card">
      <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ e-mail, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ç–µ—Å—Ç.</p>
      <form id="regForm" action="javascript:void(0)">
        <p><input required name="name" placeholder="–ò–º—è" style="width:100%;padding:8px"></p>
        <p><input required type="email" name="email" placeholder="E-mail" style="width:100%;padding:8px"></p>
        <button class="btn" type="submit">–ù–∞—á–∞—Ç—å</button>
      </form>
    </article>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ "—Å–ø–∞—Å–∏–±–æ" -->
<div id="doneModal" class="modal hidden">
  <article class="card">
    <h2>–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ!</h2>
    <p>–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –∑–∞–ø–∏—Å–∞–Ω—ã. –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º?</p>
    <p style="display:flex;gap:8px;flex-wrap:wrap">
      <a class="btn" href="../index.html">‚Ü© –ù–∞ –Ω–∞—á–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É</a>
      <button id="closeThanks" class="btn" type="button">–û—Å—Ç–∞—Ç—å—Å—è –∑–¥–µ—Å—å</button>
    </p>
  </article>
</div>

  <main class="card" style="margin-top:52px">
    <h1>–¢–µ—Å—Ç –ø–æ –ª–µ–∫—Ü–∏–∏</h1>
    <div id="quiz">
      <div class="q">
        <h3>1) –ö –∫–∞–∫–æ–º—É –ø–µ—Ä–∏–æ–¥—É –æ—Ç–Ω–æ—Å—è—Ç—Å—è –ø–µ—Ä–≤—ã–µ 1‚Äì3 –¥–Ω—è?</h3>
        <label><input type="radio" name="q1" value="a"> –û—Å–Ω–æ–≤–Ω–æ–π</label><br>
        <label><input type="radio" name="q1" value="b"> –ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–π</label><br>
        <label><input type="radio" name="q1" value="c"> –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π</label>
      </div>
      <div class="q">
        <h3>2) –ö—Ä–∞—Ç–∫–∏–π –¥–µ–≤–∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞:</h3>
        <label><input type="radio" name="q2" value="a"> –¢–µ–ø–ª–æ—Ç–∞! –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å!</label><br>
        <label><input type="radio" name="q2" value="b"> –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ! –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å! –ú–∞–∂–æ—Ä! –î—Ä—É–∂–±–∞!</label><br>
        <label><input type="radio" name="q2" value="c"> –£–¥–∏–≤–ª–µ–Ω–∏–µ! –¢–µ–º–ø! –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ!</label>
      </div>
      <div class="q">
        <h3>3) –ß—Ç–æ –¥–µ–ª–∞—Ç—å –∑–∞ 2‚Äì3 –¥–Ω—è –¥–æ –∫–æ–Ω—Ü–∞?</h3>
        <label><input type="radio" name="q3" value="a"> –ü–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—é—Ä–ø—Ä–∏–∑—ã, –≥–æ—Ç–æ–≤–∏—Ç—å —Ç—ë–ø–ª–æ–µ —Ä–∞—Å—Å—Ç–∞–≤–∞–Ω–∏–µ</label><br>
        <label><input type="radio" name="q3" value="b"> –ù–∞–∑–Ω–∞—á–∞—Ç—å –æ—Ä–≥–∞–Ω–æ–≤ —Å–∞–º–æ—É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</label><br>
        <label><input type="radio" name="q3" value="c"> –ü—Ä–æ–≤–æ–¥–∏—Ç—å —Ä–∞–∑–≤–µ–¥–∫—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –¥–µ–ª</label>
      </div>
      <button id="submitBtn" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <div id="done" class="ok hidden">–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ! –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.</div>
    </div>
    <p style="margin-top:12px"><a class="btn" href="../index.html">‚Üê –ù–∞–∑–∞–¥</a></p>
  </main>

  <script>
  const SCRIPT_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyIGDD-60B3bTrXorGrwV9Td4B3dRFqgGUN1WmnF9AaCWBj9mmlkJkIkkU5dNGQuyDz/exec';
  const TEST_ID = 'logic-shift-dev';

  // –ö–ª—é—á–∏ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  const LS_KEY_USER = `test:${TEST_ID}:user`;
  const LS_KEY_SUBMITTED = `test:${TEST_ID}:submitted`;
  const LS_CLIENT_ID = `test:${TEST_ID}:clientId`;

  // –ì–µ–Ω–µ—Ä–∏–º –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π id –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ/—Ç–µ—Å—Ç
  let clientId = localStorage.getItem(LS_CLIENT_ID);
  if (!clientId) {
    clientId = Date.now() + Math.random().toString(36).slice(2);
    localStorage.setItem(LS_CLIENT_ID, clientId);
  }

  // –ï—Å–ª–∏ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ ‚Äî —Å—Ä–∞–∑—É –±–ª–æ–∫–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
  const alreadySubmitted = localStorage.getItem(LS_KEY_SUBMITTED) === '1';
  if (alreadySubmitted) {
    document.getElementById('regModal')?.classList.add('hidden');
    // –ø–æ–∫–∞–∂–µ–º "—Å–ø–∞—Å–∏–±–æ" –∫–∞–∫ –º–æ–¥–∞–ª–∫—É
    window.addEventListener('load', ()=> document.getElementById('doneModal').classList.remove('hidden'));
  }

  // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –∏–º—è/email –µ—Å–ª–∏ –µ—Å—Ç—å
  let user = null;
  try { user = JSON.parse(localStorage.getItem(LS_KEY_USER) || 'null'); } catch(_) {}
  if (user && !alreadySubmitted) {
    document.getElementById('regModal').classList.add('hidden');
  }

  // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  document.getElementById('regForm').addEventListener('submit', (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    user = { name: fd.get('name'), email: fd.get('email') };
    localStorage.setItem(LS_KEY_USER, JSON.stringify(user));
    document.getElementById('regModal').classList.add('hidden');
  });

  // –ö–Ω–æ–ø–∫–∞ ¬´–æ—Å—Ç–∞—Ç—å—Å—è –∑–¥–µ—Å—å¬ª –≤ –º–æ–¥–∞–ª–∫–µ —Å–ø–∞—Å–∏–±–æ
  document.getElementById('closeThanks').addEventListener('click', ()=>{
    document.getElementById('doneModal').classList.add('hidden');
  });

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–∞
  const submitBtn = document.getElementById('submitBtn');
  submitBtn.addEventListener('click', async ()=>{
    if (!user) { alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.'); return; }
    if (localStorage.getItem(LS_KEY_SUBMITTED) === '1') return; // –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–æ–≤

    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏; –∫–ª—é—á = name (q1,q2,...), –∑–Ω–∞—á–µ–Ω–∏–µ = –≤—ã–±—Ä–∞–Ω–Ω–∞—è –±—É–∫–≤–∞
    const answers = {};
    document.querySelectorAll('input[type="radio"]:checked').forEach(inp => {
      answers[inp.name] = inp.value;
    });
    const correct = { q1:'c', q2:'b', q3:'a' };
    const score = Object.keys(correct).reduce((s,k)=> s + (answers[k]===correct[k] ? 1 : 0), 0);

    const payload = { ...user, clientId, testId: TEST_ID, score, answers };

    // UI-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
    submitBtn.disabled = true;
    submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶';

    try {
      // ¬´–û–≥–Ω–µ—É–ø–æ—Ä–Ω–∞—è¬ª –æ—Ç–ø—Ä–∞–≤–∫–∞ ‚Äî –±–µ–∑ —á—Ç–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ (CORS-safe)
      await fetch(SCRIPT_ENDPOINT, {
        method:'POST',
        mode:'no-cors',
        headers:{ 'Content-Type':'text/plain;charset=utf-8' },
        body: JSON.stringify(payload)
      });

      // –§–∏–∫—Å–∏—Ä—É–µ–º ¬´—Å–µ—Å—Å–∏—é¬ª –∫–∞–∫ —Å–¥–∞–Ω–Ω—É—é
      localStorage.setItem(LS_KEY_SUBMITTED, '1');

      // –ü–æ–∫–∞–∂–µ–º –º–æ–¥–∞–ª–∫—É ¬´—Å–ø–∞—Å–∏–±–æ¬ª
      document.getElementById('doneModal').classList.remove('hidden');
      document.getElementById('done')?.classList.remove('hidden'); // —Å—Ç–∞—Ä—ã–π –∑–µ–ª—ë–Ω—ã–π –±–ª–æ–∫ —Ç–æ–∂–µ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å/—É–±—Ä–∞—Ç—å
    } catch (err) {
      console.error('send error', err);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
      submitBtn.disabled = false;
      submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
    }
  });
</script>
</body>
</html>
