<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–¢–µ—Å—Ç –ø–æ –ª–µ–∫—Ü–∏–∏ ‚Äî –õ–æ–≥–∏–∫–∞ —Å–º–µ–Ω—ã</title>
  <link rel="stylesheet" href="../style.css"/>
  <script src="../theme.js" defer></script>
  <style>
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal .card{max-width:440px;width:92%}
    .hidden{display:none}

    /* –ø–æ—á–∏–Ω–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∫–Ω–æ–ø–æ–∫ –∏ disabled */
    .btn{
      background: transparent;
      color: inherit;
      cursor: pointer;
      user-select: none;
    }
    .btn:disabled{
      opacity:.6;
      cursor: not-allowed;
    }

    .ok{
      padding:16px;border:1px solid var(--border);border-radius:12px;
      background:#eaffea;margin-top:12px;color:#064e3b;font-weight:600
    }
  </style>
</head>
<body>
  <button id="theme-toggle" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô Dark mode</button>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
  <div id="regModal" class="modal">
    <article class="card">
      <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ e-mail, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ç–µ—Å—Ç.</p>
      <form id="regForm" action="javascript:void(0)">
        <p><input required name="name" placeholder="–ò–º—è" style="width:100%;padding:8px"></p>
        <p><input required type="email" name="email" placeholder="E-mail" style="width:100%;padding:8px"></p>
        <button class="btn" type="submit">–ù–∞—á–∞—Ç—å</button>
      </form>
    </article>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ "—Å–ø–∞—Å–∏–±–æ" -->
  <div id="doneModal" class="modal hidden">
    <article class="card">
      <h2>–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ!</h2>
      <p id="scoreLine" style="margin-top:8px">–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –∑–∞–ø–∏—Å–∞–Ω—ã.</p>
      <p style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
        <a class="btn" href="../index.html">‚Ü© –ù–∞ –Ω–∞—á–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É</a>
        <button id="closeThanks" class="btn" type="button">–û—Å—Ç–∞—Ç—å—Å—è –∑–¥–µ—Å—å</button>
      </p>
    </article>
  </div>

  <main class="card" style="margin-top:52px">
    <h1>–¢–µ—Å—Ç –ø–æ –ª–µ–∫—Ü–∏–∏</h1>
    <div id="quiz">
      <div class="q" style="margin:12px 0">
        <h3 style="margin:0 0 8px">1) –ö –∫–∞–∫–æ–º—É –ø–µ—Ä–∏–æ–¥—É –æ—Ç–Ω–æ—Å—è—Ç—Å—è –ø–µ—Ä–≤—ã–µ 1‚Äì3 –¥–Ω—è?</h3>
        <label><input type="radio" name="q1" value="a"> –û—Å–Ω–æ–≤–Ω–æ–π</label><br>
        <label><input type="radio" name="q1" value="b"> –ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–π</label><br>
        <label><input type="radio" name="q1" value="c"> –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π</label>
      </div>
      <div class="q" style="margin:12px 0">
        <h3 style="margin:0 0 8px">2) –ö—Ä–∞—Ç–∫–∏–π –¥–µ–≤–∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞:</h3>
        <label><input type="radio" name="q2" value="a"> –¢–µ–ø–ª–æ—Ç–∞! –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å!</label><br>
        <label><input type="radio" name="q2" value="b"> –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ! –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å! –ú–∞–∂–æ—Ä! –î—Ä—É–∂–±–∞!</label><br>
        <label><input type="radio" name="q2" value="c"> –£–¥–∏–≤–ª–µ–Ω–∏–µ! –¢–µ–º–ø! –†–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏–µ!</label>
      </div>
      <div class="q" style="margin:12px 0">
        <h3 style="margin:0 0 8px">3) –ß—Ç–æ –¥–µ–ª–∞—Ç—å –∑–∞ 2‚Äì3 –¥–Ω—è –¥–æ –∫–æ–Ω—Ü–∞?</h3>
        <label><input type="radio" name="q3" value="a"> –ü–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—é—Ä–ø—Ä–∏–∑—ã, –≥–æ—Ç–æ–≤–∏—Ç—å —Ç—ë–ø–ª–æ–µ —Ä–∞—Å—Å—Ç–∞–≤–∞–Ω–∏–µ</label><br>
        <label><input type="radio" name="q3" value="b"> –ù–∞–∑–Ω–∞—á–∞—Ç—å –æ—Ä–≥–∞–Ω–æ–≤ —Å–∞–º–æ—É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</label><br>
        <label><input type="radio" name="q3" value="c"> –ü—Ä–æ–≤–æ–¥–∏—Ç—å —Ä–∞–∑–≤–µ–¥–∫—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –¥–µ–ª</label>
      </div>

      <button id="submitBtn" class="btn" type="button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <div id="done" class="ok hidden">–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ! –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.</div>
    </div>

    <p style="margin-top:12px"><a class="btn" href="../index.html">‚Üê –ù–∞–∑–∞–¥</a></p>
  </main>

  <script>
    // === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
    const SCRIPT_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyIGDD-60B3bTrXorGrwV9Td4B3dRFqgGUN1WmnF9AaCWBj9mmlkJkIkkU5dNGQuyDz/exec';
    const TEST_ID = 'logic-shift-dev';

    // –ö–ª—é—á–∏ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
    const LS_USER      = `test:${TEST_ID}:user`;
    const LS_SUBMITTED = `test:${TEST_ID}:submitted`;
    const LS_CLIENT_ID = `test:${TEST_ID}:clientId`;
    const LS_ANSWERS   = `test:${TEST_ID}:answers`;
    const LS_SCORE     = `test:${TEST_ID}:clientScore`;

    // clientId
    let clientId = localStorage.getItem(LS_CLIENT_ID);
    if (!clientId) {
      clientId = Date.now() + Math.random().toString(36).slice(2);
      localStorage.setItem(LS_CLIENT_ID, clientId);
    }

    // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ—Ç–≤–µ—Ç—ã
    let user = null;
    try { user = JSON.parse(localStorage.getItem(LS_USER) || 'null'); } catch(_) {}
    let savedAnswers = {};
    try { savedAnswers = JSON.parse(localStorage.getItem(LS_ANSWERS) || '{}'); } catch(_) {}

    // –ü—Ä–æ—Å—Ç–∞–≤–∏–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
    window.addEventListener('DOMContentLoaded', ()=>{
      for (const [name,val] of Object.entries(savedAnswers)) {
        const el = document.querySelector(`input[name="${name}"][value="${val}"]`);
        if (el) el.checked = true;
      }
      if (user) document.getElementById('regModal').classList.add('hidden');

      // –µ—Å–ª–∏ —É–∂–µ —Å–¥–∞–≤–∞–ª–∏ ‚Äî –ø–æ–∫–∞–∂–µ–º –º–æ–¥–∞–ª–∫—É –∏ –∑–∞–±–ª–æ–∫–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      if (localStorage.getItem(LS_SUBMITTED)==='1') {
        lockQuiz();
        showThanks(localStorage.getItem(LS_SCORE));
      }
    });

    // –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤—ã–±–æ—Ä ¬´–Ω–∞ –ª–µ—Ç—É¬ª
    document.querySelectorAll('input[type="radio"]').forEach(inp=>{
      inp.addEventListener('change', ()=>{
        const a = collectAnswers();
        localStorage.setItem(LS_ANSWERS, JSON.stringify(a));
      });
    });

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    document.getElementById('regForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      user = { name: fd.get('name'), email: fd.get('email') };
      localStorage.setItem(LS_USER, JSON.stringify(user));
      document.getElementById('regModal').classList.add('hidden');
    });

    // –ö–Ω–æ–ø–∫–∞ ¬´–æ—Å—Ç–∞—Ç—å—Å—è –∑–¥–µ—Å—å¬ª
    document.getElementById('closeThanks').addEventListener('click', ()=>{
      document.getElementById('doneModal').classList.add('hidden');
    });

    // –û—Ç–ø—Ä–∞–≤–∫–∞
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.addEventListener('click', async ()=>{
      if (!user) { alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å.'); return; }
      if (localStorage.getItem(LS_SUBMITTED)==='1') return;

      const answers = collectAnswers();
      const correct = { q1:'c', q2:'b', q3:'a' }; // –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—á—ë—Ç–∞; —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç —Å–∞–º
      const total = Object.keys(answers).length;
      const clientScore = Object.keys(correct).reduce((s,k)=> s + (answers[k]===correct[k] ? 1 : 0), 0);

      // –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
      submitBtn.disabled = true;
      submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º‚Ä¶';

      try {
        const payload = { ...user, clientId, testId: TEST_ID, score: clientScore, answers };
        await fetch(SCRIPT_ENDPOINT, {
          method: 'POST',
          mode:   'no-cors',
          headers:{ 'Content-Type':'text/plain;charset=utf-8' },
          body:   JSON.stringify(payload)
        });

        localStorage.setItem(LS_SUBMITTED,'1');
        localStorage.setItem(LS_SCORE, `${clientScore}/${total}`);

        lockQuiz();
        showThanks(`${clientScore}/${total}`);
        document.getElementById('done').classList.remove('hidden'); // –º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å, –µ—Å–ª–∏ –ª–∏—à–Ω–µ–µ
      } catch (err) {
        console.error(err);
        submitBtn.disabled = false;
        submitBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
      }
    });

    // helpers
    function collectAnswers(){
      const obj = {};
      document.querySelectorAll('input[type="radio"]:checked').forEach(inp=>{
        obj[inp.name] = inp.value;
      });
      return obj;
    }

    function lockQuiz(){
      // –∑–∞–ø—Ä–µ—Ç–∏–º –º–µ–Ω—è—Ç—å –æ—Ç–≤–µ—Ç—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ
      document.querySelectorAll('input[type="radio"]').forEach(inp=> inp.disabled = true);
      submitBtn.disabled = true;
    }

    function showThanks(scoreStr){
      const line = document.getElementById('scoreLine');
      line.textContent = scoreStr ? `–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –∑–∞–ø–∏—Å–∞–Ω—ã. –†–µ–∑—É–ª—å—Ç–∞—Ç: ${scoreStr}.` : '–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –∑–∞–ø–∏—Å–∞–Ω—ã.';
      document.getElementById('doneModal').classList.remove('hidden');
    }
  </script>
</body>
</html>
